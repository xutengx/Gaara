<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>网页聊天</title>
    <script type="text/javascript" src="<?php echo VIEW;?>js/dandan.js"></script>
    <script type="text/javascript">
        //登陆的人
        $admin_name = account;
        //成员数组
        $arr_user = new Array(
//                Array('蛋蛋', 'user_img/001.jpg'),
//                Array('今心', 'user_img/002.jpg'),
//                Array('老猪', 'user_img/003.jpg'),
//                Array('涛涛', 'user_img/004.jpg'),
//                Array('张三'),
//                Array('李四'),
//                Array('王五')
        )
    </script>
    <link href="<?php echo VIEW;?>images/dandan.css" rel="stylesheet" media="screen" type="text/css"/>
    <style type="text/css">

    </style>
</head>
<body>
<div id="mid_top">
    <!--  <div class="list">
        <table border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td class="td_user td_user_click">老猪</td>
            <td class="td_hide td_hide_click">X</td>
          </tr>
        </table>
      </div>-->
</div>
<div id="top">头部</div>
<div id="body">
    <div id="left">
        <div class="box">
            <h3 class="h3 h3_1">最近聊天(<span class="n_geshu_1"></span>)</h3>
            <ul class="ul ul_1">
                <li>老猪</li>
            </ul>
            <h3 class="h3 h3_2">当前在线(<span class="n_geshu_2"></span>)</h3>
            <ul class="ul ul_2">
                <li>蛋蛋</li>
            </ul>
        </div>
        <div class="box_f"></div>
    </div>
    <div id="right">
        <div class="right_box">
            <div id="right_top">
                <!--<p><img src="images/head.jpg" alt="头象" /></p>
                老猪--></div>
            <div id="right_mid"></div>
            <div id="right_foot">蛋蛋</div>
            <div class="blank"></div>
        </div>
        <div class="right_box_foot"></div>
    </div>
    <div id="mid">
        <div id="mid_con">
            <div class="my_show">
                <div class="con_box">
                    <div class="dandan_liaotian"><img src="user_img/dandan.jpg" alt="蛋蛋聊天界面"/></div>
                </div>
            </div>
        </div>
        <div id="mid_mid"></div>
        <div id="mid_foot">
            <div id="mid_say">
                <textarea name="" cols="" rows="" id="texterea"></textarea>
            </div>
            <div id="mid_sand">发送</div>
            <div class="blank"></div>
        </div>
        <div class="mid_box"></div>
    </div>
</div>
</body>
<script>
    var ws = {};
    if (typeof(WebSocket) == 'undefined') {
        alert('你的浏览器不支持 WebSocket ，推荐使用Google Chrome 或者 Mozilla Firefox');
    } else {
        ws = new WebSocket("ws://" + host + ":2345");
        ws.onopen = function (e) {
            console.log(e);
            alert("连接成功!");
        };
        ws.onmessage = function (e) {
            console.log(e.data);
            var obj = JSON.parse(e.data);
            if (obj[0] == 'login') {
                $arr_user = [];
                for( var i in obj[1] ){
                    $arr_user.push([obj[1][i].account,'header_img',obj[1][i].id]);
                }
                //加载用户
                $(".ul").html("");//初始清空原来留在那里让w3c通过的
                for (i = 0; i < $arr_user.length; i++) {
                    dandan.newuser('.ul_2', $arr_user[i], i);//创建用户
                }
            }else if(obj[0] == 'message'){
                console.log(obj[1]);
//                sibli_hide(".list[user_id=" + obj[1].form_id +"]");
//
//                $("#user_con" + obj[1].form_id).append('<div class="my_say_con"><font color=\"#0000FF\">' + obj[1].form_id + t + "</font><p><font color=\"#333333\">" + trim2(trim($("#texterea").val())) + '</font></p></div>');
//                $("#right_mid").html($("#texterea").val());//右边显示刚发送的文字
//                $("#texterea").val("");
//                $(".my_show").scrollTop($(".con_box").height() - $(".my_show").height());//让滚动滚到最底端
            }
        };
        ws.onclose = function (e) {
            console.log('收到服务端 close');
        };
//        $('#say').on('click', function () {
//            var say = {};
//            say.to_id = $('input[name=to_id]').val();
//            say.content = $('input[name=content]').val();
//            say.type = 0;
//            ws.send(JSON.stringify(say));
//        });
        $('#img').on('click', function () {
            var fd = new FormData();
            fd.append('to_id', $('input[name=to_id]').val());
            fd.append('type', 1);
            fd.append('file_img', $('input[name=img]')[0].files[0]);

            var say = {};
            say.to_id = $('input[name=to_id]').val();
            say.type = 1;

            $.ajax({
                url: __url__('saveImg'),
                processData: false,
                contentType: false,
                data: fd,
                type: 'post',
                dataType: 'json',
                success: function (re) {
                    say.content = re.data;
                    ws.send(JSON.stringify(say));
                }
            });
        });
    }
</script>
